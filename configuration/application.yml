# This is the base configuration of the server running at open-vsx.org.
# Properties containing secrets are not included here, e.g. spring.datasource
# for database access and ovsx.storage.azure for file storage access.
# Additional properties are loaded from the file provided with the
# DEPLOYMENT_CONFIG environment variable.
logging:
  pattern:
    level: '%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]'
server:
  address: 0.0.0.0
  port: 8080
  shutdown: graceful
  error:
    path: /server-error
    whitelabel:
      enabled: false
    include-stacktrace: never
  compression:
    enabled: true
    mime-types: text/html,text/plain,text/css,application/javascript,application/json,text/xml,application/xml,application/xml+rss,text/javascript
    min-response-size: 1024
  jetty:
    threads:
      max-queue-capacity: 100
    connection-idle-timeout: 10000
spring:
  application:
    name: openvsx-server
  config:
    import: file:${DEPLOYMENT_CONFIG}
  datasource:
    hikari:
      maximum-pool-size: 10
      leak-detection-threshold: 30000
  flyway:
    baseline-on-migrate: false
  jpa:
    open-in-view: false
  resources:
    cache:
      cachecontrol:
        max-age: 4h
        cache-public: true
  session:
    store-type: jdbc
  thymeleaf:
    # disable thymeleaf view resolution, do not change lightly
    enabled: false
  lifecycle:
    timeout-per-shutdown-phase: 10s
  security:
    oauth2:
      client:
        registration:
          eclipse:
            authorization-grant-type: authorization_code
            scope: openvsx_publisher_agreement, profile
        provider:
          eclipse:
            issuer-uri: https://auth.eclipse.org/auth/realms/community
            user-name-attribute: preferred_username
management:
  server:
    port: 8081
  health:
    probes:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
      environment: ${ENVNAME}
      instance: ${HOSTNAME}
  endpoints:
    web:
      exposure:
        include:
          - health
          - prometheus
  tracing:
    sampling:
      probability: 0.01
springdoc:
  model-and-view-allowed: true
  swagger-ui:
    path: /swagger-ui
    docExpansion: list
    operationsSorter: alpha
    urlsPrimaryName: Registry API
    supportedSubmitMethods:
      - get
org:
  jobrunr:
    job-scheduler:
      enabled: true
    background-job-server:
      enabled: true
      worker-count: 2
    dashboard:
      enabled: false
    database:
      type: sql
    miscellaneous:
      allow-anonymous-data-usage: false
bucket4j:
  enabled: false
  cache-to-use: redis-cluster-jedis
  filters:
    - cache-name: buckets
      url: '/api/-/(namespace/create|publish)'
      http-response-headers:
        Access-Control-Allow-Origin: '*'
        Access-Control-Expose-Headers: X-Rate-Limit-Retry-After-Seconds, X-Rate-Limit-Remaining
      rate-limits:
        - cache-key: getParameter("token")
          bandwidths:
            - capacity: 15
              time: 1
              unit: seconds
    - cache-name: buckets
      url: '/vscode/asset/.*/.*/.*/Microsoft.VisualStudio.Services.Icons.Default'
      http-response-headers:
        Access-Control-Allow-Origin: '*'
        Access-Control-Expose-Headers: X-Rate-Limit-Retry-After-Seconds, X-Rate-Limit-Remaining
      rate-limits:
        - cache-key: '(getHeader("X-Forwarded-For")?: getRemoteAddr()).split(",")[0].trim()'
          bandwidths:
            - capacity: 75
              time: 1
              unit: seconds
    - cache-name: buckets
      url: '/vscode/(?!asset/.*/.*/.*/Microsoft.VisualStudio.Services.Icons.Default).*'
      http-response-headers:
        Access-Control-Allow-Origin: '*'
        Access-Control-Expose-Headers: X-Rate-Limit-Retry-After-Seconds, X-Rate-Limit-Remaining
      rate-limits:
        - cache-key: '(getHeader("X-Forwarded-For")?: getRemoteAddr()).split(",")[0].trim()'
          bandwidths:
            - capacity: 75
              time: 1
              unit: seconds
    - cache-name: buckets
      url: '/api/(?!(.*/.*/review(/delete)?)|(-/(namespace/create|publish))).*'
      http-response-headers:
        Access-Control-Allow-Origin: '*'
        Access-Control-Expose-Headers: X-Rate-Limit-Retry-After-Seconds, X-Rate-Limit-Remaining
      rate-limits:
        - execute-condition: getParameter("token") != null
          cache-key: getParameter("token")
          bandwidths:
            - capacity: 15
              time: 1
              unit: seconds
        - execute-condition: getParameter("token") == null
          cache-key: '(getHeader("X-Forwarded-For")?: getRemoteAddr()).split(",")[0].trim()'
          bandwidths:
            - capacity: 15
              time: 1
              unit: seconds
ovsx:
  token-prefix: ovsxat_
  storage:
    cdn:
      enabled: true
      services:
        aws: https://openvsx-staging.eclipsecontent.org/
    migration:
      enabled: false
    primary-service: aws
  webui:
    frontendRoutes: "/extension/**,/namespace/**,/user-settings/**,/admin-dashboard/**,/about,/publisher-agreement-*,/terms-of-use,/members,/adopters,/error"
  eclipse:
    base-url: https://api.eclipse.org/
    publisher-agreement:
      version: 1.1
      allowed-versions: "1,1.0,1.1"
  publishing:
    require-license: true
  redis:
    enabled: true
  elasticsearch:
    enabled: true
    ssl: true
  search:
    relevance:
      rating: 0.5
      downloads: 2.0
      timestamp: 1.2
  migrations:
    delay:
      seconds: 10800
    once-per-version: true
  extension-control:
    update-on-start: true
  integrity:
    key-pair: create
  registry:
    version: <SERVER_VERSION>
  caching:
    files-extension:
      tti: PT1H
      max-size: 200
    files-webresource:
      tti: PT1H
      max-size: 500
    files-browse:
      tti: PT1H
      max-size: 100
    average-review-rating:
      ttl: P3D
    namespace-details-json:
      ttl: PT1H
    database-search:
      ttl:PT1H
    extension-json:
      ttl: PT1H
    latest-extension-version:
      ttl: PT1H
    sitemap:
      ttl: PT1H
    malicious-extensions:
      ttl: P3D
  foregroundHttpConnPool:
    maxTotal: 50
    defaultMaxPerRoute: 50
  mail:
    from: no-reply@open-vsx.org
    revoked-access-tokens:
      subject: 'Open VSX Access Tokens Revoked'
      template: 'revoked-access-tokens.html'

  # tier-based rate limiting configuration
  rate-limit:
    enabled: true
    filters:
      - url: '/api/.*'
        http-response-headers:
          Access-Control-Allow-Origin: '*'
          Access-Control-Expose-Headers: X-Rate-Limit-Retry-After-Seconds, X-Rate-Limit-Remaining
    default-http-content-type: application/json
    default-http-response-body: >
      {
        "type": "https://open-vsx.org/probs/rate-limit-exceeded",
        "title": "Too Many Requests",
        "status": 429,
        "detail": "A request rate limit has been exceeded for your current usage tier. Open VSX enforces tier-based limits to ensure reliable service. If this is unexpected for your use case, please contact us.",
        "documentation": "https://github.com/EclipseFdn/open-vsx.org/wiki/Rate-Limiting",
        "contact": "infrastructure@eclipse-foundation.org"
      }

  # General scanning support
  scanning:
    enabled: true

    # Shared archive limits for all scanning checks (secret detection, blocklist, etc.)
    max-archive-size-bytes: 1073741824   # 1 GB total archive limit
    max-single-file-bytes: 268435456     # 256 MB per-file limit
    max-entry-count: 100000              # Max ZIP entries to process
    blocklist-check:
      enabled: true
      enforced: false

    similarity:
      enabled: true
      enforced: false
      similarity-threshold: 0.2            # Min 20% name difference allowed
      skip-if-publisher-verified: false    # Do not skip checks for verified publishers
      only-protect-verified-names: false
      allow-similarity-to-own-names: true  # Skip checks against extensions in namespaces owned by the same publisher
      only-check-new-extensions: true      # Skip checks for extension with existing versions, applies similarity checks only to new extensions

    secret-detection:
      enabled: true
      required: false
      enforced: false
      rules-path: 'classpath:scanning/secret-detection-custom-rules.yaml'
      suppression-markers: 'secret-detector:ignore,gitleaks:allow,nosecret,@suppress-secret'
      gitleaks:
        auto-fetch: true
        force-refresh: true
        output-path: '/tmp/secret-detection-rules-gitleaks.yaml'
        scheduled-refresh: true
        refresh-cron: '0 0 3 * * *'  # Daily at 3 AM
        skip-rule-ids: 'generic-api-key'  # Rule IDs that produce too many false positives
      max-findings: 200
      minified-line-threshold: 10000
      long-line-no-space-threshold: 1000
      regex-context-chars: 100
      debug-preview-chars: 10

      # Timeout & Performance
      timeout-seconds: 10
      timeout-check-interval: 100

    configured:
      # ClamAV REST wrapper - our custom Go service with file-level reporting
      # Requires clamav-rest service deployment
      clamav-rest:
        enabled: true
        enforced: false
        type: "CLAMAV_REST"
        required: true
        async: false
        timeout-minutes: 5

        # Per-scanner HTTP client configuration
        # ClamAV needs longer timeouts for large files
        http:
          max-total: 20                         # Max connections in pool
          default-max-per-route: 10             # Max connections per host
          connection-request-timeout-ms: 60000  # Time to get connection from pool (1 min)
          connect-timeout-ms: 60000             # Time to establish TCP connection (1 min)
          socket-timeout-ms: 300000             # Time to wait for response (5 min for large files)

        start:
          method: POST
          url: "http://clamav-staging:9000/scan"
          headers:
            Accept: "application/json"
          body:
            type: multipart
            file-field: "file"
          response:
            format: json
            # Our wrapper returns: { status, threats[], scanned_files, scan_time_ms }
            threats-path: "$.threats[*]"
            threat-mapping:
              # All threats in the array are malware detections
              condition: "true"
              name-path: "$.name"
              description-path: "$.name"
              severity-path: "$.severity"
              file-path-path: "$.file"
              file-hash-path: "$.file_hash"
        # ClamAV REST is synchronous - threats are delivered with the start call.
        # No separate poll/result operations are required.

      # YARA Scanner - our custom Go service with file-level reporting
      # Requires yara-rest service deployment
      yara:
        enabled: true   # Enable when yara-rest service is deployed
        type: "YARA"
        required: true
        enforced: false
        async: false     # Synchronous - YARA is fast
        timeout-minutes: 5

        http:
          max-total: 20
          default-max-per-route: 10
          connection-request-timeout-ms: 60000
          connect-timeout-ms: 60000
          socket-timeout-ms: 300000   # 5 min for large extensions

        start:
          method: POST
          url: "http://yara-staging:9001/scan"
          headers:
            Accept: "application/json"
          body:
            type: multipart
            file-field: "file"
          response:
            format: json
            # Matches are returned as an array
            threats-path: "$.matches[*]"
            threat-mapping:
              # All YARA matches are threats
              condition: "true"
              name-path: "$.rule"
              file-path-path: "$.file"
              file-hash-path: "$.file_hash"
              description-path: "$.description"
              severity-path: "$.severity"
